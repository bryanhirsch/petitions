<?php

/**
 * @file
 * Extend the entity destination class with signature specific info.
 */

class MigrateDestinationSignatureEntity extends MigrateDestinationEntity {

  /**
   * Overloading the constructor.
   */
  public function __construct() {
    parent::__construct("petition", NULL);
  }

  /**
   * Provide the schema for the signature ID.
   *
   * @return array
   *   The schema definition of the ID for a signature
   */
  static public function getKeySchema() {
    return array(
      'id' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'description' => 'ID of destination signature entity',
      ),
    );
  }

  /**
   * Return the fields that are part of a signature.
   *
   * @param object $migration
   *   the migration object
   *
   * @return array
   *   keyed array with the machine name and label of each relevant field
   *   array('machine_name' => "Human readable name", ...)
   */
  public function fields($migration = NULL) {
    $fields = array();

    $schema = drupal_get_schema_unprocessed("signature", "signature_mail");

    foreach ($schema['fields'] as $property => $info) {
      $fields[$property] = $info['description'];
    }

    $fields += migrate_handler_invoke_all('Entity', 'fields', $this->entityType, $this->bundle, $migration);

    return $fields;
  }

  /**
   * Save the date of one object from the source.
   *
   * @param object $signature
   *   entity object generated by migrate
   * @param object $row
   *   raw data coming from the data source
   *
   * @return array
   *   an array of ids from the saved data or FALSE if something goes wrong
   */
  public function import(stdClass $signature, stdClass $row) {
    $this->prepare($signature, $row);

    $id = entity_save("signature_mail", $signature);

    $this->complete($signature, $row);
    if ($id == FALSE) {
      return FALSE;
    }
    else {
      return array($signature->id);
    }
  }

  /**
   * Overloading prepare method.
   */
  public function prepare($entity, stdClass $source_row) {
    parent::prepare($entity, $source_row);

    if (isset($entity->user_first_name)) {
      $entity->user_first_name = $this->replace4byte($entity->user_first_name);
    }

    if (isset($entity->user_last_name)) {
      $entity->user_last_name = $this->replace4byte($entity->user_last_name);
    }
  }

  /**
   * Replace 4-byte utf8 chars with an undefined symbol.
   *
   * @param string $string
   *   A string.
   * 
   * @return string
   *   the string without 4 byte utf8 chars.
   */
  public function replace4byte($string) {
    return preg_replace('%(?:
          \xF0[\x90-\xBF][\x80-\xBF]{2}      # planes 1-3
        | [\xF1-\xF3][\x80-\xBF]{3}          # planes 4-15
        | \xF4[\x80-\x8F][\x80-\xBF]{2}      # plane 16
      )%xs', "ï¿½", $string);
  }
}
